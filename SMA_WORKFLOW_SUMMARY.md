# SMA (Specialist Matching Agent) Workflow Summary

## Overview

The SMA (Specialist Matching Agent) has been updated to implement a simplified workflow that focuses on the core functionality of connecting patients with specialists and managing appointments. The system now has a streamlined set of endpoints that handle the essential operations without unnecessary complexity.

## Architecture

### Core Components

1. **SMA Main Class** (`agents/sma/sma.py`)
   - Main orchestrator for specialist matching and appointment booking
   - Handles both patient and specialist operations
   - Integrates with other MindMate agents

2. **Specialist Matcher** (`agents/sma/specialits_matcher.py`)
   - Core matching logic for finding relevant specialists
   - Applies filters and preferences
   - Ranks matches based on patient criteria

3. **Appointments Manager** (`agents/sma/appointments_manager.py`)
   - Manages appointment lifecycle
   - Handles slot availability checking
   - Provides specialist statistics

4. **SMA Schemas** (`agents/sma/sma_schemas.py`)
   - Request/Response models for all endpoints
   - Validation and type safety

## Patient Endpoints

### 1. Search Specialists
- **Endpoint**: `GET /patient-sma/search-specialists`
- **Purpose**: Find specialists based on filters and preferences
- **Features**:
  - Filter by specialization, location, budget, languages
  - Sort by best match, rating, experience, fee
  - Paginated results with metadata
  - Automatic ranking based on patient preferences

### 2. Get Specialist Public Profile
- **Endpoint**: `GET /patient-sma/specialist/{specialist_id}/profile`
- **Purpose**: Get detailed information about a specific specialist
- **Features**:
  - Complete specialist information
  - Bio, specializations, experience
  - Available consultation slots
  - Ratings and reviews

### 3. Book Appointment
- **Endpoint**: `POST /patient-sma/book-appointment`
- **Purpose**: Book an appointment with a specific specialist
- **Features**:
  - Direct booking with specialist
  - Automatic slot availability check
  - Email notifications
  - Payment integration ready

### 4. Cancel Appointment
- **Endpoint**: `POST /patient-sma/cancel-appointment`
- **Purpose**: Cancel an existing appointment
- **Features**:
  - Cancel scheduled or confirmed appointments
  - Automatic notification to specialist
  - Refund processing (if applicable)

### 5. Reschedule Appointment
- **Endpoint**: `POST /patient-sma/reschedule-appointment`
- **Purpose**: Reschedule an existing appointment to a new time slot
- **Features**:
  - Change appointment time
  - Automatic slot availability check
  - Notification to specialist
  - Maintain appointment history

### 6. Get Appointment Status
- **Endpoint**: `GET /patient-sma/appointment/{appointment_id}/status`
- **Purpose**: Get current status and details of an appointment
- **Features**:
  - Real-time appointment status
  - Complete appointment details
  - Payment status
  - Session notes (if available)

## Specialist Endpoints

### 1. Get Booked Appointments
- **Endpoint**: `GET /specialist-sma/my-appointments`
- **Purpose**: Get appointments for the current specialist
- **Features**:
  - Paginated results
  - Filter by appointment status
  - Include patient details
  - Sort by appointment date

### 2. Update Appointment Status
- **Endpoint**: `POST /specialist-sma/update-appointment-status`
- **Purpose**: Update appointment status (confirm/reject) and notify patient via email
- **Features**:
  - Confirm or reject appointments
  - Automatic email notification to patient
  - Add specialist notes
  - Status tracking

### 3. Cancel Appointment
- **Endpoint**: `POST /specialist-sma/cancel-appointment`
- **Purpose**: Cancel an appointment and notify patient via email
- **Features**:
  - Cancel scheduled or confirmed appointments
  - Automatic email notification to patient
  - Add cancellation reason
  - Status tracking

### 4. Get Patient Public Profile
- **Endpoint**: `GET /specialist-sma/patient/{patient_id}/profile`
- **Purpose**: Get patient public profile information for the specialist
- **Features**:
  - Patient basic information
  - Consultation history
  - Age and demographic data
  - City and location

### 5. Get Patient Referral Report
- **Endpoint**: `GET /specialist-sma/patient/{patient_id}/referral-report`
- **Purpose**: Get patient referral report from PIMA (Patient Information Management Agent)
- **Features**:
  - Patient assessment report
  - Risk level analysis
  - Treatment recommendations
  - Generated by PIMA agent

## Data Flow

### Patient Journey
1. **Search**: Patient searches for specialists using filters
2. **Browse**: Patient views specialist profiles and availability
3. **Book**: Patient books appointment with chosen specialist
4. **Manage**: Patient can cancel, reschedule, or check appointment status

### Specialist Journey
1. **View**: Specialist views their booked appointments
2. **Manage**: Specialist can confirm, reject, or cancel appointments
3. **Review**: Specialist can view patient profiles and referral reports
4. **Notify**: Automatic email notifications are sent for all changes

## Key Features

### 1. Email Notifications
- Automatic notifications for appointment changes
- Sent to both patients and specialists
- Uses the existing email utility system

### 2. Slot Availability
- Real-time slot availability checking
- Prevents double-booking
- Considers existing appointments and specialist availability

### 3. Data Consistency
- All operations maintain data integrity
- Proper error handling and rollback mechanisms
- Validation at multiple levels

### 4. Integration Ready
- Designed to integrate with PIMA for patient reports
- Payment system integration points
- Extensible for additional features

## Database Models

### Core Models Used
- **Appointment**: Main appointment entity
- **Specialists**: Specialist information
- **Patient**: Patient information
- **SpecialistSpecializations**: Specialist specializations

### Key Relationships
- Appointment → Specialist (Many-to-One)
- Appointment → Patient (Many-to-One)
- Specialist → Specializations (Many-to-Many)

## Error Handling

### Standard Error Responses
- **400**: Bad Request (invalid input)
- **404**: Not Found (resource doesn't exist)
- **403**: Forbidden (insufficient permissions)
- **500**: Internal Server Error (system error)

### Validation
- Input validation using Pydantic models
- Business logic validation in service layer
- Database constraint validation

## Testing

### Test Coverage
- Unit tests for all SMA methods
- Mock database operations
- Test all endpoints and workflows
- Error scenario testing

### Test File
- `test_sma_workflow.py`: Comprehensive test suite

## Future Enhancements

### Potential Additions
1. **Real-time Notifications**: WebSocket support for live updates
2. **Advanced Scheduling**: Recurring appointments, group sessions
3. **Payment Integration**: Direct payment processing
4. **Video Integration**: Built-in video consultation support
5. **Analytics**: Detailed reporting and analytics

### Scalability Considerations
- Database indexing for performance
- Caching for frequently accessed data
- Microservice architecture ready
- Horizontal scaling support

## Conclusion

The updated SMA workflow provides a clean, focused implementation that handles the core specialist-patient matching and appointment management functionality. The system is designed to be maintainable, scalable, and ready for future enhancements while maintaining data consistency and providing a good user experience for both patients and specialists.
